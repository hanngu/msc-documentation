\section{Algorithm}

\textit{Under construction....}

We started out with implementing the basic ACO algorithm by \citet{nanda11} as described in chapter 2.

\subsection{Initialization}
The initialization process consists of creating the network. In this process, a Neo4J database is created, the nodes are created from the MandlCoordinates file, the edges are created from the MandlDemand file, and the travel times between each node couples with direct links are added from the MandlTravelTimes file. 
Then an amount (100) of ants are created. The ants include an ant number to distinguish the ants from each other, in addition to holding its first node(current node). The ants are able to select next node and creating routes, and adding these routes to a route set (which is a set number of routes.)

\subsection{Stop criteria:}

\textit{Preliminary a number of iterations. }

\subsection{Selecting start node}
%Selecting the first node: 
\textbf{For all ants in A: }position ants in start node 
\par
The first step is to estimate the demand value for each node. The nodes is given a demand value, which is the sum of each line in the demand.txt file.
After this, the nodes is sorted in descending order based on the demand value of each node.
Then, select the first K nodes from the list, which comprise the initial node set. Based on the demand value belonging to INS, a probability is assigned to each node, which reflects the probability of each node to be selected as the first node of the route. Then a random node is selected based on the values of provabilities. 

Start node for the next ants: Possible hot spots may be detected, and that this can be used as a start node for the next ants. 

\subsection{Selecting the next nodes}
\textbf{For all ants in A:} choose next node and update pheromone value\textbf{ until every ant has a solution }

The next nodes is selected based on the demand, the pheromone and the attractiveness for the edges. As mentioned, only the edges connected by travel time is possible to select. The route exploring stops if it reaches more than 10 nodes, and if it is stuck meaning it is not allowed to select a node twice. It then begins the next route exploring. The number of routes it is generating is a value you can set (for now: 4).
This is done by calculating the probability for next node to be selected. This probability is calculated by the pheromone(P), demand(D) and an attractive value(A), and divided by the total demand (TD), total pheromone (TP) and total attractiveness(TA).

Nodes only connected with one other node in the network, provoke premature termination of a route if selected at the initialization stage, given that no direction reversals are allowed. \citep{kechagiopoulos14}. As a result the attractive value means a route with only one edge has lower attractiveness (0.5) and nodes with more than one edge has higher attractivenesses value. As soon as the node is selected as part of a route, its value is divided by 10, in order to bias toward the selection of other nodes which have not been selected already. The choice aims to have all nodes participating to each route set since a major characteristic of a good route set is to fulfill all transfer demands. %TODO: denne må leses mer gjennom.
The probability for for each node to be selected is calculated as follows:
$$ P_{k} = \frac{D}{TD} + \frac{P}{TP} + \frac{A}{TA}$$
After each edge is given a probability, these are added in a range starting from 3, decreasing with the probability for each edge. A value between 3 and 0 is then picked, giving the edges with highest probability a large range than the others, resulting in a larger probability for this edge to be selected. 

Travel time is not taken into account in the node selection stage, because this is done when we are evaluating the route set, and the best routes is given more pheromone for next iteration. %TODO: give higher score if there is direct routes between node couples with high demand.

The routes are added to an route set, for evaluation.


\subsection{Route set evaluation}
In this stage the ants with their complete route set are selected for evaluation, and the others are discarded. This is because we want the complete route set, not just best routes; based on the constraint: The ants must have included all nodes, which is an important constraint because a passenger should be allowed to travel from every node to every other node. 
This ants are then added to the best route set. The reason this evaluation is done after is because it too complex to evaluate this during the route generation stage. 

The route sets are added to the Neo4J database, which includes Dijkstras algorithm for finding the shortest paths. 
The route sets are then evaluated by a fitness function, TOTFIT(r) inspired by \citep{kechagiopoulos14}.
This fitness value is calculated as follows:
$$ TOTFIT(r) = w_{1}F_{1}(r) + w_{2}F_{2}(r) + w_{3}F_{3}(r)$$

%Evaluation a route itself as no sense, since its path depends on the rest of the members of the same route set. As a result, all members of a route set should be evaluated as a whole. This evaluation is based on the evaluation criteria stated in previous section.
$ F_{1}(r)$ means score obtained by evaluating the route set by the total in-vehicle time
$ F_{2}(r)$ mean score obtained by evaluating the route set using criteria: direct traveler, one transfer, two transfers
$ F_{3}(r)$ means score obtained by evaluating the route set using criteria: more than two transfers 

$ w_{1}, w_{2}$, and$ w_{3}$ are user specified weights for scores $ F_{1}(r), F_{2}(r),$ and $ F_{3}(r)$, respectively. \textit{: TODO}

\subsubsection{Calculating F1}
Score is obtained by evaluating the route set by the total in-vehicle time, by calculating the smallest travel time and the travel time based on the nodes.
\begin{itemize}
\item calculate smallest travel time
\item calculate travel time based on nodes
\end{itemize}

Calculating the smallest travel time is done by Neo4J - Dijkstras. 
And the traveltime based on nodes, means the travel time it takes between nodes using the route with the edges made by the ant.This is done by calculating the difference between the selected route and the shortest path:
$$ DIFF = PathWeight(r) - NodeCoupleMinTotalTravelTime$$
$ PathWeight(r)$ : The traveltime between two nodes using the route with edges made by the ant
\par 
$ NodeCoupleMinTotalTravelTime$: the actual shortest path between the two nodes, Dijkstras

% F1(r) : score obtained by evaluating the route set r using criteria: the total in-vehicle time. 
% %Skrives om 

% If all nodes contains a list of all the other nodes including their travel time, 

% In other words, it reflects the average time spent by each passenger when traveling along a specific route set. Its value it small if the respective average traveling time is big and big is traveling time is small. In order to estimate F1(r), not only the average traveling time has to be calculated, but one also determine whether this value should be considered big or small. 
% \begin{itemize}
% \item calculate smallest travel time
% \item calculate travel time based on nodes
% \end{itemize}

\subsubsection{Calculating F2}
% F2(r) : score obtained by evaluating the route set using criteria: direct traveler, one transfer, two transfers
\subsubsection{Calculating F3}
% F3(r) : score obtained by evaluating the route set using criteria: more than two transfers 

\subsection{For all edge E in B}
\begin{itemize}
\item for all edges in B, give higher pheromone based on all the evaluation criteria. (Total travel time, number of transits, higher demand: higher priority)
\item After we have selected the best route sets, we reward the edges in the routes by giving these more pheromone.
\end{itemize}

\subsection{For all edges E in E}
\begin{itemize}
\item for all edges in E, evaporation over time. 
\end{itemize}

%TODO: skrive om, og gjøre?
%The number of buses is restricted by some number M. Then, a feasible set of edges is to be found, such that the total transportation time according to some descriptive assignment (with waiting times defined by the number of buses M) is minimized. Since the problem is so complex, only a heuristic algorithm seems appropriate. 
%\begin{itemize}
 %\item Each node will not be served by each bus, but each stop must be served by at least one route ( each node must belong to at least one route. ) Because a passenger must be able to reach a stop from any other stop by using a sequence of routes. But even though all nodes is reachable, many cases people will have to change lines to reach their destination, and this means they have to wait for the next vehicle. Therefore the travel time is the sum of transportation time along the lines plus the sum of waiting. (To include waiting time, means that a node is split into as many nodes as there are lines passing through this node, and if the original node belongs to these new nodes, they are connected by arcs denoting the average travel time. )
 %\item Because changing lines is not only time consuming but also inconvenient for the passengers, many people want to find the one with the least changes necessary. This minimum change path can be found in exactly the same way as the shortest path; instead of assigning the real waiting time for each arc denoting a possible change, one assigns a high value to those arcs, such that a is much greater than the transportation time.
%\end{itemize}



