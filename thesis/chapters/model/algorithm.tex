\section{ACO}

\textit{Under construction....}
\newline
We started out with implementing the basic ACO algorithm by \citet{nanda11} as described in chapter \ref{backgroundAndMotivation}.

\subsection{Initialization}

The network is created and initialized.

In this process, a Neo4J database is created, the nodes are created from the MandlCoordinates file shown in table \ref{table:MandlCoords} on page \pageref{table:MandlCoords}, the edges with the amount of demand are created from the MandlDemand file shown in table \ref{table:MandlDemand} on page \pageref{table:MandlDemand}, and the travel times between each node couples with direct links are added from the MandlTravelTimes file shown in table \ref{table:MandlTravelTimes} on page \pageref{table:MandlTravelTimes}. In addition to travel time and demand, each edge includes a pheromone value to be updated on each edge.

Neo4J includes built-in methods for calculating the shortest path. 

The ants include an ant number to distinguish the ants from each other, in addition to holding its start node or current node. The ants are capable of selecting the next node, creating routes, and adding these routes to a route set. As mentioned in constraints, the route size is predefined, so the algorithm / routes shall not exceed the minimum and maximum limit of \textit{k} nodes. To simplify the problem there are exactly \textit{r} routes in the route set.

\subsection{Stop criteria}

\textit{A number of iterations.}

\subsection{Selecting start node}
%Selecting the first node: 
\begin{algorithm}[H]

  \ForAll{ants a in A}{
   position a in StartNode
  }
 
\end{algorithm}

To select the start node, the demand value for each node is estimated, which is the sum of each line in the Mandl Demand table \ref{table:MandlDemand} on page \pageref{table:MandlDemand}. After this, the nodes is sorted in descending order based on the demand value of each node. Then, the first k nodes from the list is selected, which comprise the initial node set (INS). Based on the demand value belonging to INS, a probability is assigned to each node, which reflects the probability of each node to be selected as the first node of the route. Then a random node is selected based on the values of probabilities. %TODO: skrive mer her
To prevent a route from having less than the minimum number of nodes, constraint \ref{itm:constraintRouteSize}, it is not possible to select a node with a connected node that only has one edge connected to it. TODO

%Start node for the next ants: Possible hot spots may be detected, and that this can be used as a start node for the next ants. 
\subsection{Selecting the next nodes}

\begin{algorithm}[H]
  \Repeat{every ant has a solution}{
   \ForAll{ants a in A}{
    choose nextNode\\* 
    $pheromone_{(currentNode,nextNode)}+=update$
   }
  }
\end{algorithm}

The next nodes is selected based on the demand value, the pheromone value and the visited status value for the edges. Only the edges connected by travel time is possible to select, because this indicates whether it is a direct link between the two nodes. The visited status value checks if the node is visited in an earlier route within the same route set. Its value is 0 if it is unvisited, else 1, giving the unvisited nodes a higher probability of being selected. 

The selection is done by calculating the probability for the next node to be selected. This probability is calculated by adding the pheromone(P), demand(D) and an visited value value (V), and dividing it by the total demand (TD), total pheromone (TP) and the total value for all the connected edges to the node (TV).

The probability for for each node \textit{k} to be selected is calculated as follows:
$$ P_{k} = \frac{D}{TD} + \frac{P}{TP} + \frac{V}{TV}$$ 

After each edge is given a probability, these are added in a range starting from 3, decreasing with the probability value for each edge. A value between 3 and 0 is then random selected, giving the edges with highest probability a larger range than the others, resulting in a larger probability for this edge to be selected. 

\textit{Travel time is not taken into account in the node selection stage, because this is done when we are evaluating the route set, and the best routes is given more pheromone for next iteration.} %TODO: give higher score if there is direct routes between node couples with high demand.

After an node is selected, the pheromone value for this edge increases 

The node selecting phase stops if it exceeds k nodes, constraint \ref{itm:constraintRouteSize} specifies that the route size is predefined, and that the routes shall not exceed the maximum limit of nodes. It also stops if it is stuck, because it is not allowed to select a node twice, according to constraint \ref{itm:constraintCycles}, no cycles (or backtracks) in the graph is allowed. The ant then begins the next route exploring, the route exploring stops when it exceeds the maximum number of routes; as specified in constraint \ref{itm:constraintRouteSet}, there are exactly r routes in the route set. 

The routes are added to a route set, for evaluation.

\subsection{Route set evaluation}

Only the ants with a route set that is connected is selected for evaluation. This is because we want a connected graph, not just the best routes, based on evaluation criteria \ref{itm:criteriaConnectedGraph}. This important because a passenger should be allowed to travel from every node to every other node within the route set. In an undirected graph two vertices u and v are called connected if G contains a path from u to v. An ants route set can have included all nodes, but still be disconnected. So the ants with a route set that is disconnected, is excluded from the best ants. The reason this evaluation is done after is because it too complex to evaluate this during the route generation stage. 

This ants are then added to the ``best route set'' for evaluation. Evaluation a route itself as no sense, since its path depends on the rest of the members of the same route set. As a result, all routes of a route set should be evaluated as a whole. This evaluation is based on the evaluation criteria stated in previous section.

The route sets are added to the Neo4J database, and evaluated by a fitness function, TOTFIT(r), where r is the route set, inspired by \citep{kechagiopoulos14}.
This fitness value is calculated as follows:
$$ TOTFIT(r) = F_{1}(r) + F_{2}(r) + F_{3}(r)$$. 

$ F_{1}(r)$ : score obtained by evaluating the route set by the total in-vehicle time, evaluation criteria \ref{itm:criteriaTotalTravelTime}
\newline
$ F_{2}(r)$ : score obtained by evaluating the route set using criteria: direct traveler, one transfer, two transfers
\newline
$ F_{3}(r)$ : score obtained by evaluating the route set using criteria: unsatisfied customers (more than two transfers)
\newline
%$ w_{1}, w_{2}$, and$ w_{3}$ are user specified weights for scores $ F_{1}(r), F_{2}(r),$ and $ F_{3}(r)$, respectively. 
%To find w, we will calculate an average with ratio, and give weights from that, and theese weights sum is 1.  

\subsubsection{Calculating $F_{1}$}

This score is obtained by calculating the difference, $DIF$, between the the travel time using the edges included in the route set and the minimum travel time (shortest path). Calculating the minimum travel time is done by the Neo4JHandler, which includes a built-in algorithms for finding the shortest path. The selection of which algorithm is used is described in the experiments and results chapter. 
\emph{\color{red} TODO}

$$ DIF = PathWeight(r) - MinTotalTravelTime(k_{1},k_{2})$$

$ PathWeight(r)$ : travel time using the edges included in the route set
\newline
$ MinTotalTravelTime(k_{1},k_{2})$: the shortest path between the two nodes, $k_{1}$ and $k_{2}$..
 
% In other words, it reflects the average time spent by each passenger when traveling along a specific route set. Its value is small if the respective average traveling time is big and big is traveling time is small. In order to estimate F1(r), not only the average traveling time has to be calculated, but one also determine whether this value should be considered big or small. 

\subsubsection{Calculating $F_{2}$}
%TODO: skrive om dette
Score obtained by evaluating the route set using criteria \ref{itm:f2} : direct traveler, one transfer, two transfers


\begin{itemize}
\item it checks for the node couple in a route, if the route contains both the nodes, then it is a direct traveler
\item it checks if the node couple is withing 2 routes
\item it checks if the the node couple is withing 3 routes
\end{itemize}

$f_2(r) = (-3) * directCouples + (-2) * oneTransferCouples + (-1) * twoTransferCouples $

\subsubsection{Calculating F3}
%TODO: skrive om dette
it checks if the the node couple is withing more than 3 routes


\subsection{Update pheromone value on final best ants}

\begin{algorithm}[H]
  \ForAll{edges e in FBA}{
   $pheromone_e += deposit$
  }
\end{algorithm}

50\% of the best ants are added to the final best ants set, and we reward the edges in the routes by giving these more pheromone.

\subsection{Evaporation}

\begin{algorithm}[H]
  \ForAll{edges e in E}{
   $pheromone_e -= evaporation$
  }
\end{algorithm}

Edges evaporate over time, meaning the pheromone on each edge decrease after each iteration. This is inspired by the real life, that a scent decrease over time.


%TODO: skrive om, og gj√∏re?
%The number of buses is restricted by some number M. Then, a feasible set of edges is to be found, such that the total transportation time according to some descriptive assignment (with waiting times defined by the number of buses M) is minimized. Since the problem is so complex, only a heuristic algorithm seems appropriate. 
%\begin{itemize}
 %\item Each node will not be served by each bus, but each stop must be served by at least one route ( each node must belong to at least one route. ) Because a passenger must be able to reach a stop from any other stop by using a sequence of routes. But even though all nodes is reachable, many cases people will have to change lines to reach their destination, and this means they have to wait for the next vehicle. Therefore the travel time is the sum of transportation time along the lines plus the sum of waiting. (To include waiting time, means that a node is split into as many nodes as there are lines passing through this node, and if the original node belongs to these new nodes, they are connected by arcs denoting the average travel time. )
 %\item Because changing lines is not only time consuming but also inconvenient for the passengers, many people want to find the one with the least changes necessary. This minimum change path can be found in exactly the same way as the shortest path; instead of assigning the real waiting time for each arc denoting a possible change, one assigns a high value to those arcs, such that a is much greater than the transportation time.
%\end{itemize}



